# coding: utf-8
import tushare as ts
import datetime as dt
import time
import stock_class as sc
import pandas as pd
import os


# 取tushare的token并连接api
def get_tocken():
    token = ts.set_token('71a5947e1d01e9b5c5275f2de127101940acd4cdb44cc2aad9c7e7cd')
    pro = ts.pro_api(token)
    return pro


# 取系统上一日
def get_sys_date():
    today = dt.date.today()
    yestorday = today - dt.timedelta(days=0)
    formatted_yestorday = yestorday.strftime('%Y%m%d')
    return formatted_yestorday


# 取深证股票
def get_sz_stock():
    pro = sc.get_tocken()
    for _ in range(3):
        try:
            stock_list = pro.stock_basic(exchange='', list_status='L', fields='ts_code,symbol,name,area,industry,list_date')
            stock_list_sz = stock_list.loc[stock_list['ts_code'].str.contains('SZ')]
        except:
            time.sleep(2)
    return stock_list_sz


# 取上海股票
def get_sh_stock():
    pro = sc.get_tocken()
    for _ in range(3):
        try:
            stock_list = pro.stock_basic(exchange='', list_status='L', fields='ts_code,symbol,name,area,industry,list_date')
            stock_list_sh = stock_list.loc[stock_list['ts_code'].str.contains('SH')]
        except:
            time.sleep(2)
    return stock_list_sh


# 取年化回报数据
def get_return_rate(rate):
    target_annual_dir = 'D:/Program Files/tdx/vipdoc/sz/sz_tushare_annual_return/nhsy.csv'
    stock_list = pd.read_csv(target_annual_dir, usecols=['ts_code', 'year_annual_return'])
    stock_list_return = stock_list[stock_list['year_annual_return'] > rate]
    return stock_list_return

# 取区间收益
def get_backward_returns(stock_file, begin, end, window, filename):
    read_dir = 'D:/Program Files/tdx/vipdoc/sz/sz_tushare/day_download'
    df = pd.read_csv(read_dir + os.sep + stock_file, usecols=['ts_code', 'trade_date', 'open', 'close', 'pct_chg',
                                                               'vol', 'amount', 'MA_5', 'MA_10', 'MA_250'])



